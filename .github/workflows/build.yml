name: Build and Release Theme

on:
  release:
    types: [created]  # 当发布 Release 时触发

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 上传 release asset 需要写权限

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install minify tools
        run: |
          npm install -g terser clean-css-cli

      - name: Minify JS and CSS (if exists)
        run: |
          # 递归最小化 assets/js 目录下所有 .js 文件（原地覆盖）
          find assets/js -name "*.js" -type f -exec terser {} --compress --mangle -o {} \; 2>/dev/null || echo "No JS files or already minified"
          # 递归最小化 assets/css 目录下所有 .css 文件（原地覆盖）
          find assets/css -name "*.css" -type f -exec cleancss -o {} {} \; 2>/dev/null || echo "No CSS files or already minified"
          echo "Minify completed"

      - name: Get version from package.json
        id: get_version
        run: |
          PACKAGE_VERSION=$(jq -r .version package.json)
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "halo-theme-hao version $PACKAGE_VERSION"

      - name: Compress zip (original folder structure)
        run: |
          PACKAGE_VERSION=${{ steps.get_version.outputs.version }}
          PRE_ZIP_FOLDER=halo-theme-hao-${PACKAGE_VERSION}
          ARTIFACT_NAME=${PRE_ZIP_FOLDER}.zip
          ARTIFACT_PATH=dist/${ARTIFACT_NAME}
          
          echo "Artifact name: ${ARTIFACT_NAME}"
          echo "Artifact path: ${ARTIFACT_PATH}"
          
          mkdir -p "$PRE_ZIP_FOLDER"
          mkdir -p dist
          
          # 复制你原来的文件和目录（可根据实际需要增删）
          cp -r theme.yaml settings.yaml annotation-setting.yaml templates assets "$PRE_ZIP_FOLDER"/ 2>/dev/null || echo "Some files/directories missing, skipped"
          
          # 如果有其他文件（如 module.yaml、screenshot.png 等），可以继续添加：
          # cp module.yaml screenshot.png "$PRE_ZIP_FOLDER"/ 2>/dev/null || true
          
          zip -r "$ARTIFACT_PATH" "$PRE_ZIP_FOLDER"
          
          echo "ZIP created: $ARTIFACT_PATH"

      - name: Upload ZIP to Release
        uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: dist/*.zip
          # overwrite: true  # 如需覆盖同名文件，可取消注释

      - name: Upload artifact (for debug)
        uses: actions/upload-artifact@v4
        with:
          name: halo-theme-hao-zip
          path: dist/*.zip
          retention-days: 7
