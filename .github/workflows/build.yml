name: Build and Release Theme

on:
  release:
    types: [created]  # 发布 Release 时触发

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 上传 release asset 需要写权限

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install minify tools
        run: |
          npm install -g terser clean-css-cli

      - name: Minify JS and CSS in specific directories
        run: |
          # 定义需要处理的目录（只针对你指定的路径）
          DIRECTORIES=(
            "templates/assets/css"
            "templates/assets/js"
            "templates/assets/libs"
            "templates/assets/zhheo"
          )

          for dir in "${DIRECTORIES[@]}"; do
            if [ -d "$dir" ]; then
              echo "Processing directory: $dir"

              # 最小化该目录及其子目录下所有 .js 文件（原地覆盖）
              find "$dir" -type f -name "*.js" -exec terser {} --compress --mangle -o {} \; 2>/dev/null || echo "No JS files in $dir"

              # 最小化该目录及其子目录下所有 .css 文件（原地覆盖）
              find "$dir" -type f -name "*.css" -exec cleancss -o {} {} \; 2>/dev/null || echo "No CSS files in $dir"

              echo "Minify completed for $dir"
            else
              echo "Directory not found (skipped): $dir"
            fi
          done
          echo "All specified directories processed."

      - name: Get version from package.json
        id: get_version
        run: |
          PACKAGE_VERSION=$(jq -r .version package.json)
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "halo-theme-hao version $PACKAGE_VERSION"

      - name: Compress zip (original folder structure)
        run: |
          PACKAGE_VERSION=${{ steps.get_version.outputs.version }}
          PRE_ZIP_FOLDER=halo-theme-hao-${PACKAGE_VERSION}
          ARTIFACT_NAME=${PRE_ZIP_FOLDER}.zip
          ARTIFACT_PATH=dist/${ARTIFACT_NAME}
          
          echo "Artifact name: ${ARTIFACT_NAME}"
          echo "Artifact path: ${ARTIFACT_PATH}"
          
          mkdir -p "$PRE_ZIP_FOLDER"
          mkdir -p dist
          
          # 复制根目录文件和目录到临时文件夹（保持你原来的结构）
          cp -r theme.yaml settings.yaml annotation-setting.yaml templates "$PRE_ZIP_FOLDER"/ 2>/dev/null || echo "Some root files missing"
          
          # 如果还有其他根目录文件（如 module.yaml、screenshot.png、LICENSE 等），可继续添加：
          # cp module.yaml screenshot.png LICENSE "$PRE_ZIP_FOLDER"/ 2>/dev/null || true
          
          zip -r "$ARTIFACT_PATH" "$PRE_ZIP_FOLDER"
          
          echo "ZIP created: $ARTIFACT_PATH"

      - name: Upload ZIP to Release
        uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: dist/*.zip
          # overwrite: true  # 如果需要覆盖同名资产，可取消注释

      - name: Upload artifact (for debug)
        uses: actions/upload-artifact@v4
        with:
          name: halo-theme-hao-zip
          path: dist/*.zip
          retention-days: 7
